<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in" (click)="close.emit()">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col m-4 animate-scale-up" (click)="$event.stopPropagation()">
    <!-- Header -->
    <header class="p-6 border-b dark:border-gray-700 flex justify-between items-center shrink-0">
      @if (viewState() === 'editor') {
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">{{ isEditing() ? 'Editar Quiz' : 'Criar Novo Quiz' }}</h2>
      } @else {
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Importar Questões de Planilha</h2>
      }
      <button (click)="close.emit()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400">
        <span class="material-symbols-outlined">close</span>
      </button>
    </header>

    @if (viewState() === 'editor') {
      <!-- Tabs -->
      <nav class="shrink-0 border-b border-gray-200 dark:border-gray-700 px-6">
        <div class="-mb-px flex space-x-8">
          <button (click)="activeTab.set('questions')" class="py-4 px-1 border-b-2 font-semibold text-sm" [class.border-purple-500]="activeTab() === 'questions'" [class.text-purple-600]="activeTab() === 'questions'" [class.dark:text-purple-400]="activeTab() === 'questions'" [class.border-transparent]="activeTab() !== 'questions'" [class.text-gray-500]="activeTab() !== 'questions'" [class.hover:border-gray-300]="activeTab() !== 'questions'">
            Questões
          </button>
          <button (click)="activeTab.set('settings')" class="py-4 px-1 border-b-2 font-semibold text-sm" [class.border-purple-500]="activeTab() === 'settings'" [class.text-purple-600]="activeTab() === 'settings'" [class.dark:text-purple-400]="activeTab() === 'settings'" [class.border-transparent]="activeTab() !== 'settings'" [class.text-gray-500]="activeTab() !== 'settings'" [class.hover:border-gray-300]="activeTab() !== 'settings'">
            Configuração
          </button>
        </div>
      </nav>
    }

    <!-- Content -->
    <main class="flex-1 overflow-y-auto p-6">
      @switch (viewState()) {
        @case ('editor') {
          @switch (activeTab()) {
            @case ('questions') {
              <div class="space-y-6">
                <div>
                  <label for="quiz-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Título do Quiz *</label>
                  <input type="text" id="quiz-title" [ngModel]="quiz().name" (ngModelChange)="updateField('name', $event)" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                </div>

                <div class="border-t dark:border-gray-700 pt-6">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Questões</h3>
                    <div class="flex items-center gap-2">
                      <button (click)="switchToImportView()" [disabled]="!!editingQuestionId()" class="font-semibold py-2 px-4 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined text-base">upload</span>
                        Importar de Planilha
                      </button>
                      <button (click)="isBankOpen.set(true)" [disabled]="!!editingQuestionId()" class="font-semibold py-2 px-4 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" id="quiz-question-bank" [class.highlight-feature]="highlightedElementId() === 'quiz-question-bank'">
                        <span class="material-symbols-outlined text-base">account_balance</span>
                        Adicionar do Banco
                      </button>
                      <button (click)="addQuestion()" [disabled]="!!editingQuestionId()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full hover:bg-purple-700 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined">add</span> Adicionar Questão
                      </button>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    @if ((quiz().questions ?? []).length === 0 && editingQuestionId() !== 'new') {
                      <p class="text-center text-gray-500 dark:text-gray-400 py-8">Nenhuma questão adicionada.</p>
                    }
                    @for (question of quiz().questions; track question.id; let i = $index) {
                      @if (editingQuestionId() === question.id) {
                         @if(inlineFormQuestion(); as formQuestion) {
                          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-500 dark:border-purple-400 shadow-lg">
                            <div class="space-y-4">
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enunciado da Pergunta {{i + 1}} *</label>
                                  <app-simple-text-editor class="mt-1" [ngModel]="formQuestion.questionText" (ngModelChange)="updateQuestionText($event)"></app-simple-text-editor>
                              </div>
                              <div class="mt-4" id="quiz-image" [class.highlight-feature]="highlightedElementId() === 'quiz-image'">
                                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Imagem de Apoio (Opcional)</label>
                                  @if (formQuestion.imageUrl) {
                                      <div class="mt-2 p-2 border rounded-lg dark:border-gray-600 flex items-start gap-4 bg-gray-50 dark:bg-gray-700/50">
                                          <img [src]="formQuestion.imageUrl" class="w-24 h-24 object-cover rounded shrink-0">
                                          <div class="flex-1 space-y-2">
                                              <p class="text-xs text-gray-500 dark:text-gray-400 font-semibold">Posição da imagem:</p>
                                              <div class="flex gap-4">
                                                  <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                      <input type="radio" name="imagePos-{{formQuestion.id}}" value="before" [checked]="formQuestion.imagePosition === 'before'" (change)="updateImagePosition('before')">
                                                      Antes do texto
                                                  </label>
                                                  <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                      <input type="radio" name="imagePos-{{formQuestion.id}}" value="after" [checked]="formQuestion.imagePosition === 'after'" (change)="updateImagePosition('after')">
                                                      Depois do texto
                                                  </label>
                                              </div>
                                              <button (click)="removeImage()" class="mt-2 text-sm font-semibold text-red-600 hover:underline flex items-center gap-1">
                                                  <span class="material-symbols-outlined text-base">delete</span> Remover Imagem
                                              </button>
                                          </div>
                                      </div>
                                  } @else {
                                      <label [for]="'image-upload-' + formQuestion.id" class="mt-2 w-full flex justify-center px-6 py-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md cursor-pointer hover:border-purple-500 transition-colors">
                                          <div class="text-center">
                                              <span class="material-symbols-outlined text-3xl text-gray-400">add_photo_alternate</span>
                                              <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Adicionar Imagem</p>
                                              <p class="text-xs text-gray-500 dark:text-gray-400">Max 2MB, 640px de largura</p>
                                          </div>
                                      </label>
                                      <input type="file" [id]="'image-upload-' + formQuestion.id" class="sr-only" (change)="handleImageFileSelect($event)" accept="image/jpeg, image/png, image/webp">
                                  }
                              </div>
                                <div>
                                  <label class="block text-sm font-medium mb-2 dark:text-gray-300">Alternativas *</label>
                                  <div class="space-y-3">
                                    @for (alt of formQuestion.alternatives; track $index) {
                                      <div class="flex items-center gap-3">
                                        <input type="radio" [name]="formQuestion.id" [checked]="formQuestion.correctAnswerIndex === $index" (change)="setCorrectAlternative($index)" class="h-5 w-5 text-purple-600 focus:ring-purple-500 shrink-0">
                                        <input type="text" [value]="alt" (input)="updateAlternativeText($index, $event)" placeholder="Alternativa {{ $index + 1 }}" class="flex-1 p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600 focus:ring-purple-500 focus:border-purple-500">
                                        <button (click)="removeAlternative($index)" [disabled]="formQuestion.alternatives.length <= 2" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 disabled:text-gray-400 dark:disabled:text-gray-600 disabled:cursor-not-allowed">
                                          <span class="material-symbols-outlined text-base">delete</span>
                                        </button>
                                      </div>
                                    }
                                  </div>
                                  <button (click)="addAlternative()" class="mt-3 text-sm font-semibold text-purple-600 dark:text-purple-400 hover:underline flex items-center gap-1">
                                    <span class="material-symbols-outlined text-base">add_circle</span> Adicionar Alternativa
                                  </button>
                                  <p class="text-xs text-gray-500 mt-2">Marque a alternativa correta.</p>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 pt-4 border-t dark:border-gray-600">
                                        <input type="checkbox" [id]="formQuestion.id + '_isInBank'" [(ngModel)]="formQuestion.isInBank" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 shrink-0">
                                        <label [for]="formQuestion.id + '_isInBank'" class="text-sm text-gray-600 dark:text-gray-400 select-none">Adicionar esta questão ao banco de questões para reuso futuro.</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end gap-2">
                                <button (click)="cancelInlineEdit()" class="font-semibold py-2 px-4 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                                <button (click)="saveInlineQuestion()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full hover:bg-purple-700">Salvar Alterações</button>
                            </div>
                          </div>
                         }
                      } @else {
                        <div 
                          class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border dark:border-gray-600 flex items-center justify-between transition-shadow"
                          draggable="true"
                          (dragstart)="onQuestionDragStart($event, question.id)"
                          (dragend)="onQuestionDragEnd()"
                          (dragover)="onQuestionDragOver($event)"
                          (drop)="onQuestionDrop($event, question.id)"
                          [class.opacity-40]="draggedQuestionId() === question.id"
                          [class.shadow-lg]="draggedQuestionId() === question.id">
                          <div class="font-semibold text-gray-800 dark:text-gray-200 truncate flex-1 flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-400 cursor-grab">drag_indicator</span>
                            <span class="text-gray-500">{{i + 1}}.</span> 
                            @if (question.imageUrl) {
                                <span class="material-symbols-outlined text-purple-500 text-base" title="Esta questão contém uma imagem">image</span>
                            }
                            <span class="truncate block">{{ stripHtml(question.questionText) || 'Questão sem título' }}</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <button (click)="editQuestion(question)" [disabled]="!!editingQuestionId()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 disabled:opacity-50"><span class="material-symbols-outlined text-base">edit</span></button>
                            <button (click)="duplicateQuestion(question.id)" [disabled]="!!editingQuestionId()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 disabled:opacity-50"><span class="material-symbols-outlined text-base">content_copy</span></button>
                            <button (click)="deleteQuestion(question.id)" [disabled]="!!editingQuestionId()" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 disabled:opacity-50"><span class="material-symbols-outlined text-base">delete</span></button>
                          </div>
                        </div>
                      }
                    }

                    @if (editingQuestionId() === 'new') {
                      @if(inlineFormQuestion(); as formQuestion) {
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg border-2 border-purple-500 dark:border-purple-400 shadow-lg">
                          <div class="space-y-4">
                              <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enunciado da Pergunta {{ (quiz().questions ?? []).length + 1 }} *</label>
                                <app-simple-text-editor class="mt-1" [ngModel]="formQuestion.questionText" (ngModelChange)="updateQuestionText($event)"></app-simple-text-editor>
                              </div>
                              <div class="mt-4" id="quiz-image" [class.highlight-feature]="highlightedElementId() === 'quiz-image'">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Imagem de Apoio (Opcional)</label>
                                @if (formQuestion.imageUrl) {
                                    <div class="mt-2 p-2 border rounded-lg dark:border-gray-600 flex items-start gap-4 bg-gray-50 dark:bg-gray-700/50">
                                        <img [src]="formQuestion.imageUrl" class="w-24 h-24 object-cover rounded shrink-0">
                                        <div class="flex-1 space-y-2">
                                            <p class="text-xs text-gray-500 dark:text-gray-400 font-semibold">Posição da imagem:</p>
                                            <div class="flex gap-4">
                                                <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                    <input type="radio" name="imagePos-{{formQuestion.id}}" value="before" [checked]="formQuestion.imagePosition === 'before'" (change)="updateImagePosition('before')">
                                                    Antes do texto
                                                </label>
                                                <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                    <input type="radio" name="imagePos-{{formQuestion.id}}" value="after" [checked]="formQuestion.imagePosition === 'after'" (change)="updateImagePosition('after')">
                                                    Depois do texto
                                                </label>
                                            </div>
                                            <button (click)="removeImage()" class="mt-2 text-sm font-semibold text-red-600 hover:underline flex items-center gap-1">
                                                <span class="material-symbols-outlined text-base">delete</span> Remover Imagem
                                            </button>
                                        </div>
                                    </div>
                                } @else {
                                    <label [for]="'image-upload-' + formQuestion.id" class="mt-2 w-full flex justify-center px-6 py-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md cursor-pointer hover:border-purple-500 transition-colors">
                                        <div class="text-center">
                                            <span class="material-symbols-outlined text-3xl text-gray-400">add_photo_alternate</span>
                                            <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">Adicionar Imagem</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Max 2MB, 640px de largura</p>
                                        </div>
                                    </label>
                                    <input type="file" [id]="'image-upload-' + formQuestion.id" class="sr-only" (change)="handleImageFileSelect($event)" accept="image/jpeg, image/png, image/webp">
                                }
                            </div>
                              <div>
                                <label class="block text-sm font-medium mb-2 dark:text-gray-300">Alternativas *</label>
                                <div class="space-y-3">
                                  @for (alt of formQuestion.alternatives; track $index) {
                                    <div class="flex items-center gap-3">
                                      <input type="radio" [name]="formQuestion.id" [checked]="formQuestion.correctAnswerIndex === $index" (change)="setCorrectAlternative($index)" class="h-5 w-5 text-purple-600 focus:ring-purple-500 shrink-0">
                                      <input type="text" [value]="alt" (input)="updateAlternativeText($index, $event)" placeholder="Alternativa {{ $index + 1 }}" class="flex-1 p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600 focus:ring-purple-500 focus:border-purple-500">
                                      <button (click)="removeAlternative($index)" [disabled]="formQuestion.alternatives.length <= 2" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 disabled:text-gray-400 dark:disabled:text-gray-600 disabled:cursor-not-allowed">
                                        <span class="material-symbols-outlined text-base">delete</span>
                                      </button>
                                    </div>
                                  }
                                </div>
                                <button (click)="addAlternative()" class="mt-3 text-sm font-semibold text-purple-600 dark:text-purple-400 hover:underline flex items-center gap-1">
                                  <span class="material-symbols-outlined text-base">add_circle</span> Adicionar Alternativa
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Marque a alternativa correta.</p>
                              </div>
                              <div>
                                    <div class="flex items-center gap-2 pt-4 border-t dark:border-gray-600">
                                        <input type="checkbox" [id]="formQuestion.id + '_isInBank'" [(ngModel)]="formQuestion.isInBank" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 shrink-0">
                                        <label [for]="formQuestion.id + '_isInBank'" class="text-sm text-gray-600 dark:text-gray-400 select-none">Adicionar esta questão ao banco de questões para reuso futuro.</label>
                                    </div>
                                </div>
                          </div>
                          <div class="mt-4 flex justify-end gap-2">
                              <button (click)="cancelInlineEdit()" class="font-semibold py-2 px-4 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                              <button (click)="saveInlineQuestion()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-full hover:bg-purple-700">Adicionar Questão</button>
                          </div>
                        </div>
                      }
                    }
                  </div>
                </div>
              </div>
            }
            @case ('settings') {
              @if(quiz().config; as config) {
                <div class="space-y-4 max-w-3xl mx-auto">
                  <div class="p-4 border dark:border-gray-700 rounded-lg" id="quiz-setting-randomize" [class.highlight-feature]="highlightedElementId() === 'quiz-setting-randomize'">
                    <div class="flex items-center justify-between">
                      <label for="randomizeQuestions" class="font-medium text-gray-900 dark:text-gray-100 flex items-center gap-1.5">
                        <span>Randomizar Ordem das Perguntas</span>
                        <span tabindex="0" class="material-symbols-outlined text-base text-gray-400 cursor-help focus:outline-none focus:ring-2 focus:ring-purple-500 rounded" [appTooltip]="'Quando ativado, a ordem das perguntas será embaralhada a cada nova tentativa do usuário. Ajuda a prevenir colas.'">info</span>
                      </label>
                      <input id="randomizeQuestions" type="checkbox" [ngModel]="config.randomizeQuestions" (ngModelChange)="updateConfigField('randomizeQuestions', $event)" class="toggle">
                    </div>
                    @if(config.randomizeQuestions) {
                    <div class="pt-4 mt-4 border-t dark:border-gray-600">
                      <label for="questionsToDisplay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-1.5">
                        <span>Exibir quantas questões?</span>
                        <span tabindex="0" class="material-symbols-outlined text-base text-gray-400 cursor-help focus:outline-none focus:ring-2 focus:ring-purple-500 rounded" [appTooltip]="'Defina um número de perguntas a serem sorteadas do total. Ex: Se o quiz tem 20 e você define \'10\', o usuário receberá 10 perguntas sorteadas. Deixe em branco para usar todas.'">info</span>
                      </label>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Selecione o número de questões a serem sorteadas do total de {{ (quiz().questions ?? []).length }} disponíveis. Deixe em branco para exibir todas.</p>
                      <input id="questionsToDisplay" type="number" min="1" [max]="(quiz().questions ?? []).length" placeholder="Todas" [ngModel]="config.questionsToDisplay" (ngModelChange)="updateConfigField('questionsToDisplay', +$event || null)" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    }
                  </div>
                  
                  <div class="p-4 border dark:border-gray-700 rounded-lg">
                      <div class="flex items-center justify-between">
                        <label for="randomizeAlternatives" class="font-medium text-gray-900 dark:text-gray-100 flex items-center gap-1.5">
                          <span>Randomizar Ordem das Alternativas</span>
                          <span tabindex="0" class="material-symbols-outlined text-base text-gray-400 cursor-help focus:outline-none focus:ring-2 focus:ring-purple-500 rounded" [appTooltip]="'Quando ativado, a ordem das alternativas de cada pergunta será embaralhada. Dificulta a memorização da posição da resposta correta.'">info</span>
                        </label>
                        <input id="randomizeAlternatives" type="checkbox" [ngModel]="config.randomizeAlternatives" (ngModelChange)="updateConfigField('randomizeAlternatives', $event)" class="toggle">
                      </div>
                  </div>

                  <div class="flex items-center justify-between p-4 border dark:border-gray-700 rounded-lg" id="quiz-setting-feedback" [class.highlight-feature]="highlightedElementId() === 'quiz-setting-feedback'">
                    <label for="showImmediateFeedback" class="font-medium text-gray-900 dark:text-gray-100 flex items-center gap-1.5">
                      <span>Exibir Feedback Imediato</span>
                      <span tabindex="0" class="material-symbols-outlined text-base text-gray-400 cursor-help focus:outline-none focus:ring-2 focus:ring-purple-500 rounded" [appTooltip]="'Mostra ao usuário se ele acertou ou errou logo após responder.'">info</span>
                    </label>
                    <input id="showImmediateFeedback" type="checkbox" [ngModel]="config.showImmediateFeedback" (ngModelChange)="updateConfigField('showImmediateFeedback', $event)" class="toggle">
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t dark:border-gray-600">
                    <div id="quiz-setting-attempts" [class.highlight-feature]="highlightedElementId() === 'quiz-setting-attempts'" class="p-2 -m-2 rounded-xl">
                      <label class="block text-sm font-medium flex items-center gap-1.5">
                        <span>Número de Tentativas do Quiz</span>
                        <span tabindex="0" class="material-symbols-outlined text-base text-gray-400 cursor-help focus:outline-none focus:ring-2 focus:ring-purple-500 rounded" [appTooltip]="'O número máximo de vezes que um usuário pode refazer o quiz completo. Use \'1\' para uma tentativa única.'">info</span>
                      </label>
                      <input type="number" min="0" [ngModel]="config.retakeAttempts" (ngModelChange)="updateConfigField('retakeAttempts', +$event)" class="mt-1 block w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div id="quiz-setting-time-limit" [class.highlight-feature]="highlightedElementId() === 'quiz-setting-time-limit'" class="p-2 -m-2 rounded-xl">
                      <label class="block text-sm font-medium flex items-center gap-1.5">
                        <span>Tempo Máximo (min)</span>
                        <span tabindex="0" class="material-symbols-outlined text-base text-gray-400 cursor-help focus:outline-none focus:ring-2 focus:ring-purple-500 rounded" [appTooltip]="'Define um tempo limite em minutos para a conclusão do quiz. Deixe em branco ou \'0\' para não haver limite de tempo.'">info</span>
                      </label>
                      <input type="number" min="0" [ngModel]="config.maxTimeMinutes" (ngModelChange)="updateConfigField('maxTimeMinutes', +$event)" placeholder="Sem limite" class="mt-1 block w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                    </div>
                  </div>
                </div>
              }
            }
          }
        }
        @case ('import') {
          <div class="space-y-4" id="quiz-import" [class.highlight-feature]="highlightedElementId() === 'quiz-import'">
            <p class="text-gray-600 dark:text-gray-400">
              Para importar múltiplas questões, baixe nosso modelo de planilha, preencha com seus dados e faça o upload do arquivo no formato <code class="bg-gray-100 dark:bg-gray-700 p-1 rounded text-sm font-mono">.csv</code>.
            </p>

            <button (click)="downloadTemplate()" class="text-sm font-semibold text-purple-600 dark:text-purple-400 hover:underline flex items-center gap-1">
              <span class="material-symbols-outlined text-base">download</span> Baixar modelo de planilha
            </button>

            <label 
                for="csv-upload"
                class="w-full flex flex-col items-center justify-center px-6 py-10 border-2 border-dashed rounded-md cursor-pointer transition-colors"
                [class.border-purple-500]="draggingOver()" [class.bg-purple-50]="draggingOver()" [class.dark:bg-purple-900/20]="draggingOver()"
                [class.border-gray-300]="!draggingOver()" [class.dark:border-gray-600]="!draggingOver()"
                (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
              <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500">upload_file</span>
              <p class="mt-2 text-lg text-gray-600 dark:text-gray-300 font-semibold">Arraste e solte o arquivo .csv aqui</p>
              <p class="text-gray-500 dark:text-gray-400">ou</p>
              <span class="mt-2 text-sm text-purple-600 dark:text-purple-400 font-bold">Selecione o arquivo</span>
            </label>
            <input id="csv-upload" type="file" class="sr-only" accept=".csv" (change)="onFileSelected($event)">

            @if(importError(); as errorMessage) {
              <div class="bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 p-3 rounded-lg text-sm flex items-center gap-2">
                  <span class="material-symbols-outlined text-base">error</span>
                  <span>{{ errorMessage }}</span>
              </div>
            }
            @if (importFile(); as selectedFile) {
              @if (parsedQuestions().length > 0) {
                  <div class="bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-300 p-3 rounded-lg text-sm flex items-center gap-2">
                      <span class="material-symbols-outlined text-base">check_circle</span>
                      <span>Arquivo <strong>{{ selectedFile.name }}</strong> carregado. Encontradas <strong>{{ parsedQuestions().length }}</strong> questões válidas.</span>
                  </div>
              }
            }
          </div>
        }
      }
    </main>

    <!-- Footer -->
    <footer class="p-4 bg-gray-50 dark:bg-gray-900 border-t dark:border-gray-700 flex justify-end items-center gap-4 shrink-0">
       @if (viewState() === 'editor') {
        <button (click)="close.emit()" class="font-semibold py-2 px-4 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">Cancelar</button>
        <button (click)="handlePublish()" [disabled]="!canPublish()" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-full hover:bg-purple-700 disabled:bg-purple-300 dark:disabled:bg-purple-800 disabled:cursor-not-allowed transition">Publicar Quiz</button>
      } @else {
        <button (click)="switchToEditorView()" class="font-semibold py-2 px-4 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">Cancelar</button>
        <button (click)="handleImport()" [disabled]="parsedQuestions().length === 0" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-full hover:bg-purple-700 disabled:bg-purple-300 dark:disabled:bg-purple-800 disabled:cursor-not-allowed transition">
          Importar Questões
        </button>
      }
    </footer>
  </div>
</div>

@if (isBankOpen()) {
  <app-question-bank-modal 
    (close)="isBankOpen.set(false)"
    (questionsSelected)="addQuestionsFromBank($event)"
  />
}

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  .animate-scale-up { animation: scaleUp 0.3s ease-out forwards; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .toggle {
    -webkit-appearance: none;
    appearance: none;
    width: 2.75rem;
    height: 1.5rem;
    border-radius: 9999px;
    position: relative;
    background-color: #e5e7eb; /* dark:bg-gray-600 */
    transition: background-color .2s ease-in-out;
  }
  .dark .toggle { background-color: #4b5563; }
  .toggle::after {
    content: '';
    position: absolute;
    top: 0.125rem;
    left: 0.125rem;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 9999px;
    background-color: white;
    transition: transform .2s ease-in-out;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }
  .toggle:checked {
    background-color: #a78bfa; /* purple-400 */
  }
   .dark .toggle:checked {
    background-color: #8b5cf6; /* purple-500 */
  }
  .toggle:checked::after {
    transform: translateX(1.25rem);
  }
  .toggle:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>